import{j as e,G as c,R as q,T as u,a as le,b as ae,c as re,d as oe,e as de,u as ce,f as ue,g as F,h as L,P as S,i as b,B as R,A as w,k as Q,l as me,m as pe,n as he,o as xe,p as _,q as A,r as p,M as je,L as G,s as fe,O as ge,t as be,v as $,w as z,x as ve,y as Ce,z as N,C as ye,D as P,E as Le,F as Re}from"./index-48b3660d.js";import{u as X,z as J,e as v,N as K,m as C,d as Ie,a as Te,b as Y}from"./index-7f844d03.js";import{L as Se}from"./ListManager-301cb95f.js";import{u as W,L as we}from"./useCollectionDataPersistent-aa628b92.js";import{L as O}from"./LabeledSegmentedControl-9e85bab0.js";import{M as Pe,d}from"./dayjs.min-1880d2b1.js";import{c as Oe}from"./calendar-657c6ca0.js";import{B as De,l as Ee,u as Fe}from"./localizedFormat-885562f6.js";import{S as Ae}from"./Select-d5093c78.js";import"./use-input-state-5155bde1.js";function Me({clients:s,filters:n,setFilters:l}){return e.jsxs(e.Fragment,{children:[e.jsx(O,{label:"Status",data:[{label:"All",value:"all"},{label:"Pending",value:"pending"},{label:"Finished",value:"finished"},{label:"Delivered",value:"delivered"}],value:n.status,onChange:t=>l({status:t})}),e.jsx(O,{label:"Order by",data:[{label:e.jsxs(c,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(q,{}),e.jsx(u,{children:"Price"})]}),value:"price"},{label:e.jsxs(c,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(le,{}),e.jsx(u,{children:"Received"})]}),value:"receivedTimestamp"},{label:e.jsxs(c,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(ae,{}),e.jsx(u,{children:"Delivered"})]}),value:"deliveredTimestamp"}],value:n.orderBy,onChange:t=>l({orderBy:t})}),e.jsx(O,{label:"Direction",data:[{label:e.jsxs(c,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(re,{}),e.jsx(u,{children:"Ascending"})]}),value:"asc"},{label:e.jsxs(c,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(oe,{}),e.jsx(u,{children:"Descending"})]}),value:"desc"}],value:n.direction,onChange:t=>l({direction:t})}),e.jsx(Pe,{label:"Filter by clients",data:(s==null?void 0:s.map(t=>({value:t.id,label:t.name})))??[],icon:e.jsx(de,{}),placeholder:"Select clients",nothingFound:"Client not found",maxLength:36,searchable:!0,value:n.clients,onChange:t=>l({clients:t})})]})}d.extend(Oe);d.extend(Ee);const U={pending:{color:"yellow",icon:e.jsx(he,{})},finished:{color:"green",icon:e.jsx(Q,{})},delivered:{color:"cyan",icon:e.jsx(xe,{})}},Z=1,ee=1e6,H=C.object({price:C.number({invalid_type_error:"Required"}).min(Z).max(ee)});function Be({order:s,clientName:n,visibleNumbers:l,setFormValues:t,openOrderForm:a}){const r=ce(),m=ue({smallerThan:"sm"}),i=X({initialValues:{},validate:J(H)}),[h,x]=F(!1),o={centered:!0,target:".modal-container"},y=()=>_({title:e.jsx(A,{order:5,children:"Are you sure you want to mark this order as pending again?"}),children:e.jsx(u,{size:"sm",children:"The delivery date will be lost."}),labels:{confirm:"Confirm",cancel:"Cancel"},onConfirm:()=>v(s.id,{status:"pending",deliveredTimestamp:null}),...o}),I=()=>_({title:e.jsx(A,{order:5,children:"Are you sure you want to delete this order?"}),labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>Ie(s.id),confirmProps:{color:"red"},...o}),j={hover:!0,focus:!0,touch:!0};return e.jsxs(L.Row,{layoutId:s.id,children:[e.jsx("td",{children:e.jsxs(S,{position:"right",trapFocus:!0,opened:h,onChange:x.toggle,children:[e.jsx(S.Target,{children:e.jsx(b,{label:`Set as ${s.status==="pending"?"finished":s.status==="finished"?"delivered":"pending"}`,openDelay:500,withinPortal:!0,children:e.jsx(R,{size:"xs",variant:"light",color:U[s.status].color,fullWidth:!0,onClick:()=>{switch(s.status){case"pending":{s.price?v(s.id,{status:"finished"}):(i.reset(),x.open());break}case"finished":{v(s.id,{status:"delivered",deliveredTimestamp:d().valueOf()});break}case"delivered":{y();break}}},children:m?U[s.status].icon:e.jsx(u,{transform:"capitalize",children:s.status})})})}),e.jsx(S.Dropdown,{children:e.jsx("form",{onSubmit:i.onSubmit(T=>{x.close(),v(s.id,{status:"finished",...H.parse(T)})}),children:e.jsxs(c,{spacing:"sm",align:"flex-start",children:[e.jsx(K,{icon:e.jsx(q,{}),placeholder:"Enter price",min:Z,max:ee,...i.getInputProps("price")}),e.jsx(w,{variant:"filled",color:r.primaryColor,my:1,type:"submit",children:e.jsx(Q,{})})]})})})]})}),e.jsx("td",{children:n||e.jsx(u,{italic:!0,children:"Deleted"})}),e.jsx("td",{style:{textAlign:"right"},children:l?s.price?`$${s.price.toLocaleString()}`:e.jsx(De,{p:0,color:"gray",sx:{backgroundColor:"transparent"},children:"Pending"}):"*****"}),e.jsx("td",{children:e.jsx(b,{label:d(s.receivedTimestamp).calendar(d(),{sameElse:"llll"}),events:j,openDelay:500,children:e.jsx(u,{sx:{cursor:"help"},children:d(s.receivedTimestamp).format("L")})})}),e.jsx("td",{children:e.jsx(b,{label:d(s.deliveredTimestamp).calendar(d(),{sameElse:"llll"}),events:j,openDelay:500,disabled:!s.deliveredTimestamp,children:e.jsx(u,{sx:{cursor:s.deliveredTimestamp?"help":"default"},children:s.deliveredTimestamp?d(s.deliveredTimestamp).format("L"):"-"})})}),e.jsx("td",{children:e.jsxs(c,{position:"right",spacing:0,noWrap:!0,children:[e.jsx(b,{label:"Edit",children:e.jsx(w,{color:r.primaryColor,onClick:()=>{t(s),a()},children:e.jsx(me,{})})}),e.jsx(b,{label:"Delete",children:e.jsx(w,{color:"red",onClick:I,children:e.jsx(pe,{})})})]})})]})}const se=1e6,D=C.object({clientId:C.string({invalid_type_error:"Required"}).trim().min(1,{message:"Required"}),price:C.number().min(0).max(se).optional().default(0)});function ke({opened:s,closeForm:n,values:l,clients:t}){const a=X({initialValues:{clientId:""},validate:J(D)}),[r,m]=p.useState(!1);return p.useEffect(()=>{s&&(l?a.setValues({...l,price:l.price||void 0}):a.reset())},[s]),e.jsx(je,{opened:s,title:e.jsx(A,{order:5,children:l?"Edit order":"Add order"}),size:520,trapFocus:!0,onClose:n,target:".modal-container",children:e.jsxs("form",{onSubmit:a.onSubmit(i=>{n(),l?v(l.id,D.parse(i)):Te({...D.parse(i),status:"pending",receivedTimestamp:d().valueOf(),deliveredTimestamp:null})}),children:[e.jsxs(c,{align:"flex-start",spacing:"sm",grow:!0,children:[e.jsx(Ae,{label:"Client",data:(t==null?void 0:t.map(i=>({value:i.id,label:i.name})))??[],icon:r?e.jsx(G,{size:16}):e.jsx(fe,{}),placeholder:r?"Loading client...":"Select client",nothingFound:"Client not found",initiallyOpened:!1,maxLength:36,creatable:!0,searchable:!0,selectOnBlur:!0,"data-autofocus":l?void 0:!0,disabled:r,getCreateLabel:i=>`+ Add client ${i}`,onCreate:async i=>{m(!0);const h=await Y({name:i}),x=await ge(h);m(!1),a.setFieldValue("clientId",x.id)},...a.getInputProps("clientId")}),e.jsx(K,{label:"Price",parser:i=>i==null?void 0:i.replace(/\$\s?|(,*)/g,""),formatter:i=>i&&!Number.isNaN(+i)?`$ ${i}`.replace(/\B(?=(\d{3})+(?!\d))/g,","):"$ ",placeholder:"Pending",min:0,max:se,precision:2,"data-autofocus":!0,...a.getInputProps("price")})]}),e.jsx(c,{position:"right",mt:"md",children:e.jsx(R,{type:"submit",children:"Confirm"})})]})})}function Ve(){const[s,n]=be({key:"order-filters",defaultValue:{status:"all",orderBy:"receivedTimestamp",direction:"desc",clients:[],lastValues:{}},getInitialValueInEffect:!1}),l=t=>{n(a=>({...a,...t}))};return p.useEffect(()=>{const{status:t,orderBy:a,direction:r,lastValues:m}=s;l({lastValues:{...m,[t]:{orderBy:a,direction:r}}})},[s.orderBy,s.direction]),p.useEffect(()=>{l({...s.lastValues[s.status]})},[s.status]),[s,l]}const E=20;function Xe({visibleNumbers:s}){const[n,l]=Ve(),t=$(ve,z("name","asc")),[a,r]=W(t),[m,i]=p.useState(E),h=[z(n.orderBy,n.direction),Ce(m)];n.status!=="all"&&h.push(N("status","==",n.status)),n.clients.length&&h.push(N("clientId","in",n.clients));const x=$(ye,...h),[o,y]=W(x),[I,j]=F(!1),[T,M]=F(!1),[ie,B]=p.useState(),te=p.useRef(),{ref:k,entry:f}=Fe({root:te.current,threshold:.5});return p.useEffect(()=>{i(E)},[n.status]),p.useEffect(()=>{f!=null&&f.isIntersecting&&!y&&i(g=>g+E)},[f==null?void 0:f.isIntersecting]),e.jsxs(P,{children:[e.jsx(P.Header,{title:"Orders",loading:r||y,buttons:e.jsxs(e.Fragment,{children:[e.jsx(R,{leftIcon:e.jsx(Le,{}),onClick:()=>{B(void 0),j.open()},children:"New order"}),e.jsx(R,{variant:"light",leftIcon:e.jsx(Re,{}),onClick:M.open,children:"Manage clients"})]}),filters:e.jsx(Me,{clients:a,filters:n,setFilters:l}),withNumbersToggle:!0}),e.jsxs(P.Body,{ref:k,children:[e.jsx(ke,{opened:I,closeForm:j.close,values:ie,clients:a}),e.jsx(Se,{opened:T,close:M.close,label:"client",items:a,addItem:Y}),e.jsxs(we,{in:!!(a&&o),children:[e.jsxs(L,{children:[e.jsxs(L.Header,{children:[e.jsx("th",{style:{width:0},children:"Status"}),e.jsx("th",{children:"Client"}),e.jsx("th",{style:{width:0,textAlign:"right"},children:"Price"}),e.jsx("th",{style:{width:0,textAlign:"center"},children:"Received"}),e.jsx("th",{style:{width:0,textAlign:"center"},children:"Delivered"}),e.jsx("th",{style:{width:0}})]}),e.jsx(L.Body,{children:o==null?void 0:o.map(g=>{var V;return e.jsx(Be,{order:g,clientName:(V=a==null?void 0:a.find(ne=>ne.id===g.clientId))==null?void 0:V.name,visibleNumbers:s,setFormValues:B,openOrderForm:j.open},g.id)})})]}),(o==null?void 0:o.length)===m&&e.jsx(c,{ref:k,pt:"xs",pb:"lg",position:"center",children:e.jsx(G,{})})]})]})]})}export{Xe as default};
