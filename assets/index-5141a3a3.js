import{j as e,G as l,R as Z,T as b,aJ as H,c as ee,d as te,aK as Y,aL as Q,g as w,r as x,M as v,q as M,a6 as k,L as q,aM as se,B as C,O as ae,u as ne,h as T,i as E,aN as oe,A as B,l as re,m as ie,p as le,v as N,w as O,a1 as de,t as ce,y as ue,z as me,a0 as xe,D as S,E as pe,aO as he}from"./index-48b3660d.js";import{u as ge,z as je,l as fe,n as be,o as G,N as Ce,m as g,p as Le}from"./index-7f844d03.js";import{L as ye}from"./ListManager-301cb95f.js";import{u as V,L as Ie}from"./useCollectionDataPersistent-aa628b92.js";import{L as W}from"./LabeledSegmentedControl-9e85bab0.js";import{S as U,T as Te,a as De}from"./SelectValue-cf47be54.js";import{M as X,d as L}from"./dayjs.min-1880d2b1.js";import{D as Fe}from"./TimeRangeInput-12a1ae0d.js";import{C as Ee}from"./Checkbox-0a5e1d3d.js";import{c as Se}from"./calendar-657c6ca0.js";import{B as we,l as Me,u as Re}from"./localizedFormat-885562f6.js";import"./use-input-state-5155bde1.js";function Ae({tags:n,filters:r,updateFilter:t}){return e.jsxs(e.Fragment,{children:[e.jsx(W,{label:"Order by",data:[{label:e.jsxs(l,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(Z,{}),e.jsx(b,{children:"Amount"})]}),value:"amount"},{label:e.jsxs(l,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(H,{}),e.jsx(b,{children:"Date"})]}),value:"date"}],value:r.orderBy,onChange:o=>t({orderBy:o})}),e.jsx(W,{label:"Direction",data:[{label:e.jsxs(l,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(ee,{}),e.jsx(b,{children:"Ascending"})]}),value:"asc"},{label:e.jsxs(l,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(te,{}),e.jsx(b,{children:"Descending"})]}),value:"desc"}],value:r.direction,onChange:o=>t({direction:o})}),e.jsx(X,{label:"Filter by tags",data:(n==null?void 0:n.map(({id:o,name:s,color:p})=>({value:o,label:s,color:p})))??[],icon:e.jsx(Y,{}),placeholder:"Select tags",nothingFound:"Tag not found",itemComponent:Q,valueComponent:U,maxLength:18,searchable:!0,value:r.tags,onChange:o=>t({tags:o})})]})}const _=1e6,$=g.object({tagIds:g.array(g.string()).nonempty({message:"Required"}),description:g.string().trim().optional(),amount:g.number().min(0).max(_).optional().default(0),date:g.date(),deductFromFunds:g.boolean()});function Pe({opened:n,closeForm:r,values:t,tags:o}){const s=ge({initialValues:{tagIds:[],description:"",amount:0,date:new Date,deductFromFunds:!1},validate:je($)}),[p,c]=w(!1),[u,m]=x.useState(!1),[y,D]=x.useState(""),[d,I]=x.useState("red");return x.useEffect(()=>{n&&(t?s.setValues({...t,date:L(t.date).toDate()}):s.reset())},[n]),e.jsx(v,{opened:n,title:e.jsx(M,{order:5,children:t?"Edit expense":"Add expense"}),size:520,trapFocus:!0,onClose:r,target:".modal-container",children:e.jsxs("form",{onSubmit:s.onSubmit(a=>{r();const i=$.parse(a),j=L(i.date).format("YYYY-MM-DD");t?fe(t.id,{...i,date:j}):be({...i,date:j})}),children:[e.jsxs(k,{align:"stretch",spacing:"sm",children:[e.jsx(X,{label:"Tags",data:(o==null?void 0:o.map(({id:a,name:i,color:j})=>({value:a,label:i,color:j})))??[],icon:u?e.jsx(q,{size:16}):e.jsx(Y,{}),placeholder:u?"Loading tag...":"Select tags",nothingFound:"Tag not found",itemComponent:Q,valueComponent:U,initiallyOpened:!1,maxLength:18,creatable:!0,searchable:!0,"data-autofocus":t?void 0:!0,disabled:u,getCreateLabel:a=>`+ Add tag ${a}`,onCreate:a=>{D(a),c.open()},...s.getInputProps("tagIds")}),e.jsx(v,{opened:p,title:e.jsx(M,{order:5,children:"Select tag color"}),onClose:c.close,target:".modal-container",children:e.jsxs(k,{children:[e.jsx(se,{value:d,setValue:I}),e.jsxs(l,{position:"right",spacing:"sm",children:[e.jsx(C,{variant:"default",onClick:c.close,children:"Cancel"}),e.jsx(C,{variant:"filled",onClick:async()=>{c.close(),m(!0);const a=await G({name:y,color:d}),i=await ae(a);m(!1),s.setFieldValue("tagIds",[...s.values.tagIds,i.id])},children:"Confirm"})]})]})}),e.jsx(Te,{label:"Description",...s.getInputProps("description")}),e.jsxs(l,{align:"flex-start",spacing:"sm",grow:!0,children:[e.jsx(Ce,{label:"Amount",parser:a=>a==null?void 0:a.replace(/\$\s?|(,*)/g,""),formatter:a=>a&&!Number.isNaN(+a)?`$ ${a}`.replace(/\B(?=(\d{3})+(?!\d))/g,","):"$ ",placeholder:"Enter amount",min:0,max:_,precision:2,"data-autofocus":!0,...s.getInputProps("amount")}),e.jsx(Fe,{label:"Date",icon:e.jsx(H,{}),placeholder:"Pick date",...s.getInputProps("date")})]}),e.jsx(Ee,{label:"Deduct from funds",...s.getInputProps("deductFromFunds",{type:"checkbox"})})]}),e.jsx(l,{position:"right",mt:"md",children:e.jsx(C,{type:"submit",children:"Confirm"})})]})})}L.extend(Se);L.extend(Me);function ve({expense:n,tags:r,visibleNumbers:t,setFormValues:o,openExpenseForm:s}){const p=ne(),c=()=>le({title:e.jsx(M,{order:5,children:"Are you sure you want to delete this expense?"}),labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>Le(n.id),confirmProps:{color:"red"},centered:!0,target:".modal-container"}),u={hover:!0,focus:!0,touch:!0};return e.jsxs(T.Row,{layoutId:n.id,children:[e.jsx("td",{children:e.jsx(l,{spacing:8,noWrap:!0,children:r==null?void 0:r.map(m=>e.jsx(we,{color:m.color,radius:"sm",children:m.name},m.id))})}),e.jsx("td",{children:n.description}),e.jsx("td",{children:e.jsxs(l,{position:n.deductFromFunds?"apart":"right",spacing:"sm",noWrap:!0,children:[n.deductFromFunds&&e.jsx(E,{label:"Deducted from funds",events:u,withinPortal:!0,children:e.jsx(De,{variant:"light",radius:"xl",children:e.jsx(oe,{})})}),t?`$${n.amount.toLocaleString()}`:"*****"]})}),e.jsx("td",{children:e.jsx(b,{children:L(n.date).format("L")})}),e.jsx("td",{children:e.jsxs(l,{position:"right",spacing:0,noWrap:!0,children:[e.jsx(E,{label:"Edit",withinPortal:!0,children:e.jsx(B,{color:p.primaryColor,onClick:()=>{o(n),s()},children:e.jsx(re,{})})}),e.jsx(E,{label:"Delete",withinPortal:!0,children:e.jsx(B,{color:"red",onClick:c,children:e.jsx(ie,{})})})]})})]})}const z=20;function Ge({visibleNumbers:n}){const r=N(de,O("name","asc")),[t,o]=V(r),[s,p]=ce({key:"expense-filters",defaultValue:{orderBy:"date",direction:"desc",tags:[]},getInitialValueInEffect:!1}),c=h=>{p(F=>({...F,...h}))},[u,m]=x.useState(z),y=[O(s.orderBy,s.direction),ue(u)];s.tags.length&&y.push(me("tagIds","array-contains-any",s.tags));const D=N(xe,...y),[d,I]=V(D),[a,i]=w(!1),[j,R]=w(!1),[J,A]=x.useState(),K=x.useRef(),{ref:P,entry:f}=Re({root:K.current,threshold:.5});return x.useEffect(()=>{f!=null&&f.isIntersecting&&!I&&m(h=>h+z)},[f==null?void 0:f.isIntersecting]),e.jsxs(S,{children:[e.jsx(S.Header,{title:"Expenses",loading:o||I,buttons:e.jsxs(e.Fragment,{children:[e.jsx(C,{leftIcon:e.jsx(pe,{}),onClick:()=>{A(void 0),i.open()},children:"New expense"}),e.jsx(C,{variant:"light",leftIcon:e.jsx(he,{}),onClick:R.open,children:"Manage tags"})]}),filters:e.jsx(Ae,{tags:t,filters:s,updateFilter:c}),withNumbersToggle:!0}),e.jsxs(S.Body,{ref:P,children:[e.jsx(Pe,{opened:a,closeForm:i.close,values:J,tags:t}),e.jsx(ye,{opened:j,close:R.close,label:"tag",items:t,addItem:G}),e.jsxs(Ie,{in:!!(t&&d),children:[e.jsxs(T,{children:[e.jsxs(T.Header,{children:[e.jsx("th",{style:{width:0},children:"Tags"}),e.jsx("th",{children:"Description"}),e.jsx("th",{style:{width:0,textAlign:"right"},children:"Amount"}),e.jsx("th",{style:{width:0,textAlign:"center"},children:"Date"}),e.jsx("th",{style:{width:0}})]}),e.jsx(T.Body,{children:d==null?void 0:d.map(h=>e.jsx(ve,{expense:h,tags:t==null?void 0:t.filter(F=>h.tagIds.includes(F.id)),visibleNumbers:n,setFormValues:A,openExpenseForm:i.open},h.id))})]}),(d==null?void 0:d.length)===u&&e.jsx(l,{ref:P,pt:"xs",pb:"lg",position:"center",children:e.jsx(q,{})})]})]})]})}export{Ge as default};
