import{j as e,G as o,R as q,T as d,a as re,b as ae,c as oe,d as de,e as ce,u as ue,f as me,g as F,h as I,P as w,i as b,B as S,A as P,k as Q,l as pe,m as he,n as xe,o as je,p as z,q as M,r as x,M as ge,L as G,s as fe,O as be,t as N,v as _,w as ve,x as Ce,y as ye,z as V,C as Le,D as O,E as Re,F as Te}from"./index-5ff1983a.js";import{u as X,z as J,e as v,N as K,m as C,d as Ie,a as Se,b as Y}from"./index-a67f9d8b.js";import{L as we}from"./ListManager-ed59ad17.js";import{u as W,L as Pe}from"./useCollectionDataPersistent-3151dea0.js";import{L as D}from"./LabeledSegmentedControl-01309ecf.js";import{M as Oe,d as a}from"./dayjs.min-c1d4d187.js";import{c as De,l as Ae,u as Ee}from"./localizedFormat-d9e5c86f.js";import{B as Fe}from"./Badge-f1b67808.js";import{S as Me}from"./Select-ea469a6c.js";import"./use-input-props-04222ffb.js";import"./clamp-23377890.js";function ke({clients:s,filters:r,updateFilter:t}){return e.jsxs(e.Fragment,{children:[e.jsx(D,{label:"Status",data:[{label:"All",value:"all"},{label:"Pending",value:"pending"},{label:"Finished",value:"finished"},{label:"Delivered",value:"delivered"}],value:r.status,onChange:n=>t({status:n})}),e.jsx(D,{label:"Order by",data:[{label:e.jsxs(o,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(q,{}),e.jsx(d,{children:"Price"})]}),value:"price"},{label:e.jsxs(o,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(re,{}),e.jsx(d,{children:"Received"})]}),value:"receivedTimestamp"},{label:e.jsxs(o,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(ae,{}),e.jsx(d,{children:"Delivered"})]}),value:"deliveredTimestamp"}],value:r.orderBy,onChange:n=>t({orderBy:n})}),e.jsx(D,{label:"Direction",data:[{label:e.jsxs(o,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(oe,{}),e.jsx(d,{children:"Ascending"})]}),value:"asc"},{label:e.jsxs(o,{spacing:"xs",position:"center",noWrap:!0,children:[e.jsx(de,{}),e.jsx(d,{children:"Descending"})]}),value:"desc"}],value:r.direction,onChange:n=>t({direction:n})}),e.jsx(Oe,{label:"Filter by clients",data:(s==null?void 0:s.map(n=>({value:n.id,label:n.name})))??[],icon:e.jsx(ce,{}),placeholder:"Select clients",nothingFound:"Client not found",maxLength:36,searchable:!0,value:r.clients,onChange:n=>t({clients:n})})]})}a.extend(De);a.extend(Ae);const U={pending:{color:"yellow",icon:e.jsx(xe,{})},finished:{color:"green",icon:e.jsx(Q,{})},delivered:{color:"cyan",icon:e.jsx(je,{})}},Z=1,ee=1e6,H=C.object({price:C.number({invalid_type_error:"Required"}).min(Z).max(ee)});function Be({order:s,clientName:r,visibleNumbers:t,setFormValues:n,openOrderForm:l}){const m=ue(),p=me({smallerThan:"sm"}),i=X({initialValues:{},validate:J(H)}),[j,c]=F(!1),y={centered:!0,target:".modal-container"},u=()=>z({title:e.jsx(M,{order:5,children:"Are you sure you want to mark this order as pending again?"}),children:e.jsx(d,{size:"sm",children:"The delivery date will be lost."}),labels:{confirm:"Confirm",cancel:"Cancel"},onConfirm:()=>v(s.id,{status:"pending",deliveredTimestamp:null}),...y}),L=()=>z({title:e.jsx(M,{order:5,children:"Are you sure you want to delete this order?"}),labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>Ie(s.id),confirmProps:{color:"red"},...y}),R={hover:!0,focus:!0,touch:!0};return e.jsxs(I.Row,{layoutId:s.id,children:[e.jsx("td",{children:e.jsxs(w,{position:"right",trapFocus:!0,opened:j,onChange:c.toggle,children:[e.jsx(w.Target,{children:e.jsx(b,{label:`Set as ${s.status==="pending"?"finished":s.status==="finished"?"delivered":"pending"}`,openDelay:500,withinPortal:!0,children:e.jsx(S,{size:"xs",variant:"light",color:U[s.status].color,fullWidth:!0,onClick:()=>{switch(s.status){case"pending":{s.price?v(s.id,{status:"finished"}):(i.reset(),c.open());break}case"finished":{v(s.id,{status:"delivered",deliveredTimestamp:a().valueOf()});break}case"delivered":{u();break}}},children:p?U[s.status].icon:e.jsx(d,{transform:"capitalize",children:s.status})})})}),e.jsx(w.Dropdown,{children:e.jsx("form",{onSubmit:i.onSubmit(f=>{c.close(),v(s.id,{status:"finished",...H.parse(f)})}),children:e.jsxs(o,{spacing:"sm",align:"flex-start",children:[e.jsx(K,{icon:e.jsx(q,{}),placeholder:"Enter price",min:Z,max:ee,...i.getInputProps("price")}),e.jsx(P,{variant:"filled",color:m.primaryColor,my:1,type:"submit",children:e.jsx(Q,{})})]})})})]})}),e.jsx("td",{children:r||e.jsx(d,{italic:!0,children:"Deleted"})}),e.jsx("td",{style:{textAlign:"right"},children:t?s.price?`$${s.price.toLocaleString()}`:e.jsx(Fe,{p:0,color:"gray",sx:{backgroundColor:"transparent"},children:"Pending"}):"*****"}),e.jsx("td",{children:e.jsx(b,{label:a(s.receivedTimestamp).calendar(a(),{sameElse:"llll"}),events:R,openDelay:500,children:e.jsx(d,{sx:{cursor:"help"},children:a(s.receivedTimestamp).format("L")})})}),e.jsx("td",{children:e.jsx(b,{label:a(s.deliveredTimestamp).calendar(a(),{sameElse:"llll"}),events:R,openDelay:500,disabled:!s.deliveredTimestamp,children:e.jsx(d,{sx:{cursor:s.deliveredTimestamp?"help":"default"},children:s.deliveredTimestamp?a(s.deliveredTimestamp).format("L"):"-"})})}),e.jsx("td",{children:e.jsxs(o,{position:"right",spacing:0,noWrap:!0,children:[e.jsx(b,{label:"Edit",children:e.jsx(P,{color:m.primaryColor,onClick:()=>{n(s),l()},children:e.jsx(pe,{})})}),e.jsx(b,{label:"Delete",children:e.jsx(P,{color:"red",onClick:L,children:e.jsx(he,{})})})]})})]})}const se=1e6,A=C.object({clientId:C.string({invalid_type_error:"Required"}).trim().min(1,{message:"Required"}),price:C.number().min(0).max(se).optional().default(0)});function $e({opened:s,closeForm:r,values:t,clients:n}){const l=X({initialValues:{clientId:""},validate:J(A)}),[m,p]=x.useState(!1);return x.useEffect(()=>{s&&(t?l.setValues({...t,price:t.price||void 0}):l.reset())},[s]),e.jsx(ge,{opened:s,title:e.jsx(M,{order:5,children:t?"Edit order":"Add order"}),size:520,trapFocus:!0,onClose:r,target:".modal-container",children:e.jsxs("form",{onSubmit:l.onSubmit(i=>{r(),t?v(t.id,A.parse(i)):Se({...A.parse(i),status:"pending",receivedTimestamp:a().valueOf(),deliveredTimestamp:null})}),children:[e.jsxs(o,{align:"flex-start",spacing:"sm",grow:!0,children:[e.jsx(Me,{label:"Client",data:(n==null?void 0:n.map(i=>({value:i.id,label:i.name})))??[],icon:m?e.jsx(G,{size:16}):e.jsx(fe,{}),placeholder:m?"Loading client...":"Select client",nothingFound:"Client not found",initiallyOpened:!1,maxLength:36,creatable:!0,searchable:!0,selectOnBlur:!0,"data-autofocus":t?void 0:!0,disabled:m,getCreateLabel:i=>`+ Add client ${i}`,onCreate:async i=>{p(!0);const j=await Y({name:i}),c=await be(j);p(!1),l.setFieldValue("clientId",c.id)},...l.getInputProps("clientId")}),e.jsx(K,{label:"Price",parser:i=>i==null?void 0:i.replace(/\$\s?|(,*)/g,""),formatter:i=>i&&!Number.isNaN(+i)?`$ ${i}`.replace(/\B(?=(\d{3})+(?!\d))/g,","):"$ ",placeholder:"Pending",min:0,max:se,precision:2,"data-autofocus":!0,...l.getInputProps("price")})]}),e.jsx(o,{position:"right",mt:"md",children:e.jsx(S,{type:"submit",children:"Confirm"})})]})})}const E=20;function Je({visibleNumbers:s}){const r=N(ve,_("name","asc")),[t,n]=W(r),[l,m]=Ce({key:"order-filters",defaultValue:{status:"all",orderBy:"receivedTimestamp",direction:"desc",clients:[]},getInitialValueInEffect:!1}),p=h=>{m(T=>({...T,...h}))},[i,j]=x.useState(E),c=[_(l.orderBy,l.direction),ye(i)];l.status!=="all"&&c.push(V("status","==",l.status)),l.clients.length&&c.push(V("clientId","in",l.clients));const y=N(Le,...c),[u,L]=W(y),[R,f]=F(!1),[ie,k]=F(!1),[te,B]=x.useState(),ne=x.useRef(),{ref:$,entry:g}=Ee({root:ne.current,threshold:.5});return x.useEffect(()=>{j(E),p({orderBy:["all","pending","finished"].includes(l.status)?"receivedTimestamp":"deliveredTimestamp",direction:"desc"})},[l.status]),x.useEffect(()=>{g!=null&&g.isIntersecting&&!L&&j(h=>h+E)},[g==null?void 0:g.isIntersecting]),e.jsxs(O,{children:[e.jsx(O.Header,{title:"Orders",loading:n||L,buttons:e.jsxs(e.Fragment,{children:[e.jsx(S,{leftIcon:e.jsx(Re,{}),onClick:()=>{B(void 0),f.open()},children:"New order"}),e.jsx(S,{variant:"light",leftIcon:e.jsx(Te,{}),onClick:k.open,children:"Manage clients"})]}),filters:e.jsx(ke,{clients:t,filters:l,updateFilter:p}),withNumbersToggle:!0}),e.jsxs(O.Body,{ref:$,children:[e.jsx($e,{opened:R,closeForm:f.close,values:te,clients:t}),e.jsx(we,{opened:ie,close:k.close,label:"client",items:t,addItem:Y}),e.jsxs(Pe,{in:!!(t&&u),children:[e.jsxs(I,{children:[e.jsxs(I.Header,{children:[e.jsx("th",{style:{width:0},children:"Status"}),e.jsx("th",{children:"Client"}),e.jsx("th",{style:{width:0,textAlign:"right"},children:"Price"}),e.jsx("th",{style:{width:0,textAlign:"center"},children:"Received"}),e.jsx("th",{style:{width:0,textAlign:"center"},children:"Delivered"}),e.jsx("th",{style:{width:0}})]}),e.jsx(I.Body,{children:u==null?void 0:u.map(h=>{var T;return e.jsx(Be,{order:h,clientName:(T=t==null?void 0:t.find(le=>le.id===h.clientId))==null?void 0:T.name,visibleNumbers:s,setFormValues:B,openOrderForm:f.open},h.id)})})]}),(u==null?void 0:u.length)===i&&e.jsx(o,{ref:$,pt:"xs",pb:"lg",position:"center",children:e.jsx(G,{})})]})]})]})}export{Je as default};
